{"version":3,"names":["leancloudSelector","url","encodeURI","document","getElementById","querySelector","app_id","app_key","server_url","CONFIG","leancloud_visitors","fetchData","api_server","Counter","method","data","fetch","headers","body","JSON","stringify","page","isPost","hostname","location","visitors","decodeURI","id","title","dataset","flagTitle","encodeURIComponent","then","response","json","results","length","counter","innerText","time","objectId","__op","amount","catch","error","console","security","addCount","querySelectorAll","entries","map","element","$in","target","find","item","showTime","slice","toLowerCase","addEventListener"],"sources":["lean-analytics.js.map"],"sourcesContent":["/* global CONFIG */\n/* eslint-disable no-console */\n\n(function() {\n  const leancloudSelector = url => {\n    url = encodeURI(url);\n    return document.getElementById(url).querySelector('.leancloud-visitors-count');\n  };\n\n  const addCount = Counter => {\n    const visitors = document.querySelector('.leancloud_visitors');\n    const url = decodeURI(visitors.id);\n    const title = visitors.dataset.flagTitle;\n\n    Counter('get', `/classes/Counter?where=${encodeURIComponent(JSON.stringify({ url }))}`)\n      .then(response => response.json())\n      .then(({ results }) => {\n        if (results.length > 0) {\n          const counter = results[0];\n          leancloudSelector(url).innerText = counter.time + 1;\n          Counter('put', '/classes/Counter/' + counter.objectId, {\n            time: {\n              '__op'  : 'Increment',\n              'amount': 1\n            }\n          })\n            .catch(error => {\n              console.error('Failed to save visitor count', error);\n            });\n        } else if (CONFIG.leancloud_visitors.security) {\n          leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';\n          console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \\n However, you can still use LeanCloud without security, by setting `security` option to `false`.');\n        } else {\n          Counter('post', '/classes/Counter', { title, url, time: 1 })\n            .then(response => response.json())\n            .then(() => {\n              leancloudSelector(url).innerText = 1;\n            })\n            .catch(error => {\n              console.error('Failed to create', error);\n            });\n        }\n      })\n      .catch(error => {\n        console.error('LeanCloud Counter Error', error);\n      });\n  };\n\n  const showTime = Counter => {\n    const visitors = document.querySelectorAll('.leancloud_visitors');\n    const entries = [...visitors].map(element => {\n      return decodeURI(element.id);\n    });\n\n    Counter('get', `/classes/Counter?where=${encodeURIComponent(JSON.stringify({ url: { '$in': entries } }))}`)\n      .then(response => response.json())\n      .then(({ results }) => {\n        for (const url of entries) {\n          const target = results.find(item => item.url === url);\n          leancloudSelector(url).innerText = target ? target.time : 0;\n        }\n      })\n      .catch(error => {\n        console.error('LeanCloud Counter Error', error);\n      });\n  };\n\n  const { app_id, app_key, server_url } = CONFIG.leancloud_visitors;\n  const fetchData = api_server => {\n    const Counter = (method, url, data) => {\n      return fetch(`${api_server}/1.1${url}`, {\n        method,\n        headers: {\n          'X-LC-Id'     : app_id,\n          'X-LC-Key'    : app_key,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(data)\n      });\n    };\n    if (CONFIG.page.isPost) {\n      if (CONFIG.hostname !== location.hostname) return;\n      addCount(Counter);\n    } else if (document.querySelectorAll('.post-title-link').length >= 1) {\n      showTime(Counter);\n    }\n  };\n\n  let api_server;\n  if (server_url) {\n    api_server = server_url;\n  } else if (app_id.slice(-9) === '-MdYXbMMI') {\n    api_server = `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;\n  }\n\n  document.addEventListener('page:loaded', () => {\n    if (api_server) {\n      fetchData(api_server);\n    } else {\n      fetch(`https://app-router.leancloud.cn/2/route?appId=${app_id}`)\n        .then(response => response.json())\n        .then(({ api_server }) => {\n          fetchData(`https://${api_server}`);\n        });\n    }\n  });\n})();\n"],"mappings":"CAGA,WACE,MAAMA,EAAoBC,IACxBA,EAAMC,UAAUD,GACTE,SAASC,eAAeH,GAAKI,cAAc,+BA6D9CC,OAAEA,EAAMC,QAAEA,EAAOC,WAAEA,GAAeC,OAAOC,mBACzCC,EAAYC,IAChB,MAAMC,EAAU,CAACC,EAAQb,EAAKc,IACrBC,MAAM,GAAGJ,QAAiBX,IAAO,CACtCa,SACAG,QAAS,CACP,UAAgBX,EAChB,WAAgBC,EAChB,eAAgB,oBAElBW,KAAMC,KAAKC,UAAUL,KAGzB,GAAIN,OAAOY,KAAKC,OAAQ,CACtB,GAAIb,OAAOc,WAAaC,SAASD,SAAU,OAxE9BV,KACf,MAAMY,EAAWtB,SAASE,cAAc,uBAClCJ,EAAMyB,UAAUD,EAASE,IACzBC,EAAQH,EAASI,QAAQC,UAE/BjB,EAAQ,MAAO,0BAA0BkB,mBAAmBZ,KAAKC,UAAU,CAAEnB,YAC1E+B,MAAKC,GAAYA,EAASC,SAC1BF,MAAK,EAAGG,cACP,GAAIA,EAAQC,OAAS,EAAG,CACtB,MAAMC,EAAUF,EAAQ,GACxBnC,EAAkBC,GAAKqC,UAAYD,EAAQE,KAAO,EAClD1B,EAAQ,MAAO,oBAAsBwB,EAAQG,SAAU,CACrDD,KAAM,CACJE,KAAU,YACVC,OAAU,KAGXC,OAAMC,IACLC,QAAQD,MAAM,+BAAgCA,EAAM,GAE1D,MAAWnC,OAAOC,mBAAmBoC,UACnC9C,EAAkBC,GAAKqC,UAAY,yDACnCO,QAAQD,MAAM,+OAEd/B,EAAQ,OAAQ,mBAAoB,CAAEe,QAAO3B,MAAKsC,KAAM,IACrDP,MAAKC,GAAYA,EAASC,SAC1BF,MAAK,KACJhC,EAAkBC,GAAKqC,UAAY,CAAC,IAErCK,OAAMC,IACLC,QAAQD,MAAM,mBAAoBA,EAAM,GAE9C,IAEDD,OAAMC,IACLC,QAAQD,MAAM,0BAA2BA,EAAM,GAC/C,EAqCFG,CAASlC,EACX,MAAWV,SAAS6C,iBAAiB,oBAAoBZ,QAAU,GAnCpDvB,KACf,MACMoC,EAAU,IADC9C,SAAS6C,iBAAiB,wBACbE,KAAIC,GACzBzB,UAAUyB,EAAQxB,MAG3Bd,EAAQ,MAAO,0BAA0BkB,mBAAmBZ,KAAKC,UAAU,CAAEnB,IAAK,CAAEmD,IAAOH,SACxFjB,MAAKC,GAAYA,EAASC,SAC1BF,MAAK,EAAGG,cACP,IAAK,MAAMlC,KAAOgD,EAAS,CACzB,MAAMI,EAASlB,EAAQmB,MAAKC,GAAQA,EAAKtD,MAAQA,IACjDD,EAAkBC,GAAKqC,UAAYe,EAASA,EAAOd,KAAO,CAC5D,KAEDI,OAAMC,IACLC,QAAQD,MAAM,0BAA2BA,EAAM,GAC/C,EAoBFY,CAAS3C,EACX,EAGF,IAAID,EACAJ,EACFI,EAAaJ,EACiB,cAArBF,EAAOmD,OAAO,KACvB7C,EAAa,WAAWN,EAAOmD,MAAM,EAAG,GAAGC,qCAG7CvD,SAASwD,iBAAiB,eAAe,KACnC/C,EACFD,EAAUC,GAEVI,MAAM,iDAAiDV,KACpD0B,MAAKC,GAAYA,EAASC,SAC1BF,MAAK,EAAGpB,iBACPD,EAAU,WAAWC,IAAa,GAExC,GAEH,CAvGD","ignoreList":[]}